options:
  logging: CLOUD_LOGGING_ONLY
  machineType: "E2_HIGHCPU_8"

substitutions:
  _APP_DIR: "app"
  _REGION: "us-central1"
  _AR_REPO: "finops-app"                       # Artifact Registry repo (Docker)
  _SERVICE_NAME: "finops-controller"           # Cloud Run service name
  _RUNTIME_SA_EMAIL: "finops-runtime@${PROJECT_ID}.iam.gserviceaccount.com"

  # App config (non-secret)
  _BQ_DATASET: "finops_curated"
  _BQ_ALERTS_TABLE: "cur_alerts"

  # Secret Manager: Slack webhook secret name (no version here)
  _SLACK_SECRET_NAME: "finops-slack-webhook"

  # Image tag
  _IMAGE: "${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_AR_REPO}/${_SERVICE_NAME}:${SHORT_SHA}"

steps:
  # Build image
  - name: gcr.io/cloud-builders/docker
    id: "build-image"
    dir: ${_APP_DIR}
    args: ["build","-t","${_IMAGE}","-f","Dockerfile","."]

  # Push image
  - name: gcr.io/cloud-builders/docker
    id: "push-image"
    args: ["push","${_IMAGE}"]

  # STEP: compute FULL_IMAGE with digest and trigger infra-apply
  - name: gcr.io/google.com/cloudsdktool/cloud-sdk:slim
    id: "trigger-infra-apply"
    entrypoint: bash
    args:
      - -c
      - |
        set -euo pipefail
        IMAGE_PATH="${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_AR_REPO}/${_IMAGE_NAME}"

        # Get the digest of the image you just pushed (tagged with $SHORT_SHA)
        DIGEST="$(gcloud artifacts docker images describe \
          "${IMAGE_PATH}:${SHORT_SHA}" \
          --format='get(image_summary.digest)')"

        FULL_IMAGE="${IMAGE_PATH}@${DIGEST}"
        echo "Will deploy: ${FULL_IMAGE}"

        # Kick infra-apply and pass the image as a substitution
        gcloud builds triggers run ${_INFRA_APPLY_TRIGGER_ID} \
          --branch=main \
          --substitutions=_CONTROLLER_IMAGE="${FULL_IMAGE}"

  # - name: hashicorp/terraform:1.7.5
  #   id: tf-apply-cloud-run
  #   dir: infra
  #   entrypoint: sh
  #   args:
  #     - -lc
  #     - |
  #       terraform init -input=false
  #       terraform apply -auto-approve \
  #         -var="project_id=$PROJECT_ID" \
  #         -var="region=${_REGION}" \
  #         -var="service_name=${_SERVICE_NAME}" \
  #         -var="image=us-central1-docker.pkg.dev/$PROJECT_ID/${_AR_REPO}/${_SERVICE_NAME}:${SHORT_SHA}"

images:
  - ${_IMAGE}